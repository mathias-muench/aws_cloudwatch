#!/usr/bin/env python
import boto.ec2.cloudwatch
import datetime
import time
import sys
import os
import socket
import getopt

import pprint

def usage():
    sys.stderr.write("""Check_MK AWS Cloudwatch Data Source

USAGE: aws_cloudwatch [OPTIONS] NAMESPACE DIMENSION
       aws_cloudwatch -h

ARGUMENTS:
  NAMESPACE                       AWS Cloudwatch namespace
  DIMENSION                       AWS Cloudwatch dimension to select

OPTIONS:
  -h, --help                      Show this help message and exit
  -p MINUTES, --period MINUTES    metric period, default is 1 minute
  -a, --agent                     Also retrieve data from the normal Check_MK Agent.
                                  This makes sense if you query a EC2 instance that
                                  you also want to Monitor with Check_MK.
  -t, --timeout SECS              Set the network timeout when connecting the agent (option -a).
                                  Default is 60 seconds.
  --debug                         Debug mode: let Python exceptions come through
  -i MINUTES, --interval MIUNTES  metric query time interval, default is 15 minutes

""")

short_options = 'hi:at:p:'
long_options  = [
    'help', 'agent', 'debug', 'timeout=', "period=", "interval="
]

opt_debug               = False
opt_agent               = False
opt_timeout             = 60
opt_period              = 1
opt_interval            = 15

error = None
error_exit = 1

try:
    opts, args = getopt.getopt(sys.argv[1:], short_options, long_options)
except getopt.GetoptError, err:
    sys.stderr.write("%s\n" % err)
    sys.exit(1)

for o,a in opts:
    if o in [ '--debug' ]:
        opt_debug = True
    elif o in [ '-a', '--agent' ]:
        opt_agent = True
    elif o in [ '-p', '--period' ]:
        opt_period = int(a)
    elif o in [ '-i', '--modules' ]:
        opt_interval = int(a)
    elif o in [ '-t', '--timeout' ]:
        opt_timeout = int(a)
    elif o in [ '-h', '--help' ]:
        usage()
        sys.exit(0)

socket.setdefaulttimeout(opt_timeout)
def my_get_agent_info_tcp(hostname):
    response = ""
    try:
        # TODO: gethostbyname() automatically detects IP addresses and does
        # *not* contact any nameserver in that case. So the following two
        # lines of code should not be neccessary:
        if hostname[0] in "123456789":
            ipaddress = hostname
        else:
            ipaddress = socket.gethostbyname(hostname)
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        try:
            s.settimeout(opt_timeout)
        except:
            pass # some old Python versions lack settimeout(). Better ignore than fail
        s.connect((ipaddress, 6556))
        try:
            s.setblocking(1)
        except:
            pass
        response = ""
        while True:
            out = s.recv(4096, socket.MSG_WAITALL)
            if out and len(out) > 0:
                response += out
            else:
                break
        s.close()
        return response
    except Exception, e:
        if opt_debug:
            raise
    return response

namespace =  sys.argv[1]
region = boto.ec2.cloudwatch.CloudWatchConnection.DefaultRegionName

if namespace == "AWS/EC2":
    # Note: This check only works in an OMD environment!
    sys.path.append(os.path.expanduser("~/share/check_mk/modules"))
    execfile(os.path.expanduser("~/etc/check_mk/defaults"))
    execfile(os.path.expanduser("~/share/check_mk/modules/prediction.py"))
    execfile(os.path.expanduser("~/share/check_mk/modules/check_mk_base.py"))

    response = simple_livestatus_query("GET hosts\nColumns: alias address\nFilter: name = %s\n" % sys.argv[2])
    id, ip = response.strip().split(";")
    pprint.pprint(id)
    pprint.pprint(ip)
    dimension = { "InstanceId": id }
    print my_get_agent_info_tcp(ip)
else:
    dimension = dict([ sys.argv[2].split(".")[0].split("=") ])

c = boto.ec2.cloudwatch.connect_to_region(region)

metrics = c.list_metrics(namespace=namespace, dimensions=dimension)

if metrics:
    end=datetime.datetime.utcnow()
    start =  end - datetime.timedelta(seconds=900)

    print "<<<aws_cloudwatch>>>"

    datapoints = [ (m, m.query(start, end, m.Statistics, None)) for m in metrics ]
    for (m, q) in datapoints:
        if q and m.name != "SentMessageSize":
            r = sorted(q, key = lambda k: k['Timestamp'], reverse = True)[0]
            print m.name, r['Timestamp'].strftime("%s"), r['SampleCount'], r['Unit'], r['Average'], r['Maximum'], r['Minimum'], r['Sum']
