#!/usr/bin/env python
import boto.ec2.cloudwatch
import datetime
import time
#import pprint
c = boto.ec2.cloudwatch.connect_to_region('eu-central-1')
namespace = 'AWS/RDS'
metrics = c.list_metrics(namespace=namespace)
ids = set(map(lambda z: z.get('DBInstanceIdentifier')[0], [ y.dimensions for y in metrics if y.dimensions.get('DBInstanceIdentifier') ]))
end=datetime.datetime.utcnow() - datetime.timedelta(minutes=1)
start =  end - datetime.timedelta(minutes=5)
for i in ids:
    print "<<<<%s_%s>>>>" % (namespace.replace("/", "_"), i)
    print "<<<AWS_RDS>>>"
    datapoints = [ (z, z.query(start, end, z.Statistics, None, 300)) for z in metrics if z.dimensions.get('DBInstanceIdentifier') == [ i ]]
    for (m, q) in datapoints:
        if (q):
            print m.name, q[0]['Unit'], q[0]['Timestamp'].isoformat(), q[0]['SampleCount'], q[0]['Average'], q[0]['Maximum'], q[0]['Minimum'], q[0]['Sum']
    print "<<<<>>>>"
