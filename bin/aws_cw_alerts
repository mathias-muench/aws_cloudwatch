#!/usr/bin/env python
# vi:autoindent:expandtab:shiftwidth=4:tabstop=4

import sys
import getopt
import boto3

#import pprint

def get_alarms(session, account):
    cloudwatch = session.client('cloudwatch')

    paginator = cloudwatch.get_paginator('describe_alarms')
    for response in paginator.paginate():
        #pprint.pprint(response)
        for i in response['MetricAlarms']:
            piggy_name = ".".join(filter(None, [i['Dimensions'][0]['Value'], i['Namespace'].replace('/', '_'), account]))
            print "<<<<%s>>>>" % piggy_name
            print "<<<local>>>"
            print "0 AWSCW/%s - %s - %s" % (i['AlarmName'], i['StateValue'], i['StateReason'])
            print "<<<<>>>>"

short_options = 'a:'
long_options  = [
    'accounts='
]

opt_accounts = []

try:
    opts, args = getopt.getopt(sys.argv[1:], short_options, long_options)
except getopt.GetoptError, err:
    sys.stderr.write("%s\n" % err)
    sys.exit(1)

for o,a in opts:
    if o in [ '-a', '--accounts' ]:
        opt_accounts = a.split(',')

if len(args) != 0:
    sys.exit(1)

session = boto3.Session()
if opt_accounts:
    for account in opt_accounts:
        sts = session.client('sts')
        assumed_role = sts.assume_role(RoleArn = "arn:aws:iam::%s:role/CheckMK" % account, RoleSessionName = "CheckMK")
        assumed_session = boto3.Session(
            aws_access_key_id = assumed_role['Credentials']['AccessKeyId'],
            aws_secret_access_key = assumed_role['Credentials']['SecretAccessKey'],
            aws_session_token = assumed_role['Credentials']['SessionToken']
        )
        get_alarms(assumed_session, account)
else:
    get_alarms(session, None)
